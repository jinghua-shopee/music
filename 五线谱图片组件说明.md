# 五线谱图片组件改造说明

## 📝 改造内容

已成功将原本的Canvas五线谱渲染方式改为使用云端图片的方式，实现了自动下载和本地缓存。

## 🔧 主要修改

### 1. 图片管理器 `imageManager`

**位置**: `miniprogram/utils/imageManager.js`

**功能特点**:
- 自动从云端下载所有五线谱图片
- 本地缓存管理，避免重复下载
- 支持下载进度监控
- 提供错误处理和重试机制
- 支持缓存清理功能

### 2. 五线谱图片组件 `staff-image`

**位置**: `miniprogram/components/staff-image/`

**文件结构**:
```
staff-image/
├── staff-image.js      # 组件逻辑
├── staff-image.wxml    # 组件模板
└── staff-image.wxss    # 组件样式
```

**功能特点**:
- 支持高音符号(treble)和低音符号(bass)
- 优先使用本地缓存图片
- 缓存不可用时自动使用远程图片
- 图片加载失败时显示占位符
- 响应式布局，自适应容器大小

### 3. 云端图片存储

**云端地址**: `https://music-1253799806.cos.ap-guangzhou.myqcloud.com/pic_v2/`

**图片命名规则**: `{clef}_{noteName}_{position}.png`
- `clef`: 谱号类型 (`treble` 或 `bass`)
- `noteName`: 音符名称 (如 `C4`, `D4`, `A4` 等)
- `position`: 五线谱位置 (如 `第2间`, `第3线`, `上加2线` 等)

**覆盖范围**:
- 高音符号: A2 到 D6 (25张图片)
- 低音符号: C1 到 C5 (29张图片)
- 总计: 54张图片

### 4. 应用启动流程

**修改**: `miniprogram/app.js`

```javascript
async onLaunch() {
  // 初始化图片管理器，自动下载所有图片
  await this.initializeImages()
}
```

**功能**:
- 小程序启动时自动初始化图片下载
- 提供全局下载状态管理
- 支持页面间的状态同步

### 5. 用户界面改进

**首页下载状态** (`pages/index/index`):
- 显示图片下载进度条
- 下载完成前禁用学习功能
- 提供重新下载按钮
- 清晰的状态提示

**测试页面** (`pages/test-staff/test-staff`):
- 实时显示下载状态
- 测试五线谱组件显示
- 支持音符切换测试
- 显示本地缓存和远程图片路径

## 🎯 使用方法

### 基本用法
```xml
<staff-image note="{{noteObject}}" clef="treble" />
```

### 属性说明
- `note`: 音符对象，需包含`name`属性（如"C4", "D4"等）
- `clef`: 谱号类型，支持"treble"（高音符号）和"bass"（低音符号）

### 音符对象格式
```javascript
{
  name: 'C4',           // 音符名称（必需）
  pianoKey: 'c4',       // 钢琴键位
  staffPosition: 'line1', // 五线谱位置
  jianpu: '1'           // 简谱记号
}
```

## 🔄 缓存机制

### 本地缓存位置
```
${wx.env.USER_DATA_PATH}/staff_images/
├── treble_C4_第2间.png
├── treble_D4_第3线.png
├── bass_A4_上加2线.png
└── ...
```

### 缓存策略
- **智能检查**: 启动时检查本地是否已有图片
- **增量下载**: 只下载缺失的图片
- **持久化存储**: 图片保存在用户数据目录
- **自动回退**: 本地图片不可用时使用远程图片

## ✅ 优势

1. **性能提升**: 
   - 本地缓存避免重复下载
   - 无需Canvas渲染，直接显示图片
   - 并发下载提高初始化速度

2. **用户体验**: 
   - 清晰的下载进度提示
   - 离线使用本地缓存图片
   - 自动错误处理和重试

3. **维护性**: 
   - 云端图片统一管理
   - 支持图片更新和版本控制
   - 本地缓存自动管理

4. **扩展性**: 
   - 易于添加新的音符和谱号
   - 支持不同图片质量和尺寸
   - 可扩展到其他乐器

## 🛠️ 开发调试

### 获取下载状态
```javascript
const app = getApp()
const progress = app.getImageDownloadProgress()
console.log('下载进度:', progress)
```

### 获取图片路径
```javascript
const imageManager = app.getImageManager()
const imagePath = imageManager.getLocalImagePath('C4', 'treble')
console.log('图片路径:', imagePath)
```

### 清理缓存
```javascript
await imageManager.clearCache()
await imageManager.initialize()
```

## 📁 文件清单

### 新增文件
```
miniprogram/
├── utils/
│   └── imageManager.js         # 图片管理器
├── components/staff-image/
│   ├── staff-image.js          # 五线谱图片组件
│   ├── staff-image.wxml
│   └── staff-image.wxss
└── pages/test-staff/           # 测试页面
    ├── test-staff.js
    ├── test-staff.wxml
    ├── test-staff.wxss
    └── test-staff.json
```

### 修改文件
```
miniprogram/
├── app.js                      # 添加图片初始化
├── pages/index/                # 添加下载状态显示
│   ├── index.js
│   ├── index.wxml
│   └── index.wxss
└── pages/learning/             # 使用新的图片组件
    ├── learning.wxml
    └── learning.json
```

### 删除文件
```
miniprogram/
└── 五线谱/                     # 删除本地图片目录
    ├── treble_*.png (已删除)
    └── bass_*.png (已删除)
```

## 🎉 完成状态

✅ 图片管理器创建完成  
✅ 云端图片配置完成  
✅ 组件改造完成  
✅ 应用启动流程完成  
✅ 用户界面改进完成  
✅ 测试页面创建完成  
✅ 本地图片清理完成  
✅ 文档更新完成  

现在小程序会在启动时自动从云端下载所有五线谱图片到本地缓存，用户可以看到下载进度，下载完成后即可正常使用学习功能！ 