# äº”çº¿è°±å›¾ç‰‡ç»„ä»¶æ”¹é€ è¯´æ˜

## ğŸ“ æ”¹é€ å†…å®¹

å·²æˆåŠŸå°†åŸæœ¬çš„Canvasäº”çº¿è°±æ¸²æŸ“æ–¹å¼æ”¹ä¸ºä½¿ç”¨äº‘ç«¯å›¾ç‰‡çš„æ–¹å¼ï¼Œå®ç°äº†è‡ªåŠ¨ä¸‹è½½å’Œæœ¬åœ°ç¼“å­˜ã€‚

## ğŸ”§ ä¸»è¦ä¿®æ”¹

### 1. å›¾ç‰‡ç®¡ç†å™¨ `imageManager`

**ä½ç½®**: `miniprogram/utils/imageManager.js`

**åŠŸèƒ½ç‰¹ç‚¹**:
- è‡ªåŠ¨ä»äº‘ç«¯ä¸‹è½½æ‰€æœ‰äº”çº¿è°±å›¾ç‰‡
- æœ¬åœ°ç¼“å­˜ç®¡ç†ï¼Œé¿å…é‡å¤ä¸‹è½½
- æ”¯æŒä¸‹è½½è¿›åº¦ç›‘æ§
- æä¾›é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- æ”¯æŒç¼“å­˜æ¸…ç†åŠŸèƒ½

### 2. äº”çº¿è°±å›¾ç‰‡ç»„ä»¶ `staff-image`

**ä½ç½®**: `miniprogram/components/staff-image/`

**æ–‡ä»¶ç»“æ„**:
```
staff-image/
â”œâ”€â”€ staff-image.js      # ç»„ä»¶é€»è¾‘
â”œâ”€â”€ staff-image.wxml    # ç»„ä»¶æ¨¡æ¿
â””â”€â”€ staff-image.wxss    # ç»„ä»¶æ ·å¼
```

**åŠŸèƒ½ç‰¹ç‚¹**:
- æ”¯æŒé«˜éŸ³ç¬¦å·(treble)å’Œä½éŸ³ç¬¦å·(bass)
- ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜å›¾ç‰‡
- ç¼“å­˜ä¸å¯ç”¨æ—¶è‡ªåŠ¨ä½¿ç”¨è¿œç¨‹å›¾ç‰‡
- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½ç¬¦
- å“åº”å¼å¸ƒå±€ï¼Œè‡ªé€‚åº”å®¹å™¨å¤§å°

### 3. äº‘ç«¯å›¾ç‰‡å­˜å‚¨

**äº‘ç«¯åœ°å€**: `https://music-1253799806.cos.ap-guangzhou.myqcloud.com/pic_v2/`

**å›¾ç‰‡å‘½åè§„åˆ™**: `{clef}_{noteName}_{position}.png`
- `clef`: è°±å·ç±»å‹ (`treble` æˆ– `bass`)
- `noteName`: éŸ³ç¬¦åç§° (å¦‚ `C4`, `D4`, `A4` ç­‰)
- `position`: äº”çº¿è°±ä½ç½® (å¦‚ `ç¬¬2é—´`, `ç¬¬3çº¿`, `ä¸ŠåŠ 2çº¿` ç­‰)

**è¦†ç›–èŒƒå›´**:
- é«˜éŸ³ç¬¦å·: A2 åˆ° D6 (25å¼ å›¾ç‰‡)
- ä½éŸ³ç¬¦å·: C1 åˆ° C5 (29å¼ å›¾ç‰‡)
- æ€»è®¡: 54å¼ å›¾ç‰‡

### 4. åº”ç”¨å¯åŠ¨æµç¨‹

**ä¿®æ”¹**: `miniprogram/app.js`

```javascript
async onLaunch() {
  // åˆå§‹åŒ–å›¾ç‰‡ç®¡ç†å™¨ï¼Œè‡ªåŠ¨ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
  await this.initializeImages()
}
```

**åŠŸèƒ½**:
- å°ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–å›¾ç‰‡ä¸‹è½½
- æä¾›å…¨å±€ä¸‹è½½çŠ¶æ€ç®¡ç†
- æ”¯æŒé¡µé¢é—´çš„çŠ¶æ€åŒæ­¥

### 5. ç”¨æˆ·ç•Œé¢æ”¹è¿›

**é¦–é¡µä¸‹è½½çŠ¶æ€** (`pages/index/index`):
- æ˜¾ç¤ºå›¾ç‰‡ä¸‹è½½è¿›åº¦æ¡
- ä¸‹è½½å®Œæˆå‰ç¦ç”¨å­¦ä¹ åŠŸèƒ½
- æä¾›é‡æ–°ä¸‹è½½æŒ‰é’®
- æ¸…æ™°çš„çŠ¶æ€æç¤º

**æµ‹è¯•é¡µé¢** (`pages/test-staff/test-staff`):
- å®æ—¶æ˜¾ç¤ºä¸‹è½½çŠ¶æ€
- æµ‹è¯•äº”çº¿è°±ç»„ä»¶æ˜¾ç¤º
- æ”¯æŒéŸ³ç¬¦åˆ‡æ¢æµ‹è¯•
- æ˜¾ç¤ºæœ¬åœ°ç¼“å­˜å’Œè¿œç¨‹å›¾ç‰‡è·¯å¾„

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•
```xml
<staff-image note="{{noteObject}}" clef="treble" />
```

### å±æ€§è¯´æ˜
- `note`: éŸ³ç¬¦å¯¹è±¡ï¼Œéœ€åŒ…å«`name`å±æ€§ï¼ˆå¦‚"C4", "D4"ç­‰ï¼‰
- `clef`: è°±å·ç±»å‹ï¼Œæ”¯æŒ"treble"ï¼ˆé«˜éŸ³ç¬¦å·ï¼‰å’Œ"bass"ï¼ˆä½éŸ³ç¬¦å·ï¼‰

### éŸ³ç¬¦å¯¹è±¡æ ¼å¼
```javascript
{
  name: 'C4',           // éŸ³ç¬¦åç§°ï¼ˆå¿…éœ€ï¼‰
  pianoKey: 'c4',       // é’¢ç´é”®ä½
  staffPosition: 'line1', // äº”çº¿è°±ä½ç½®
  jianpu: '1'           // ç®€è°±è®°å·
}
```

## ğŸ”„ ç¼“å­˜æœºåˆ¶

### æœ¬åœ°ç¼“å­˜ä½ç½®
```
${wx.env.USER_DATA_PATH}/staff_images/
â”œâ”€â”€ treble_C4_ç¬¬2é—´.png
â”œâ”€â”€ treble_D4_ç¬¬3çº¿.png
â”œâ”€â”€ bass_A4_ä¸ŠåŠ 2çº¿.png
â””â”€â”€ ...
```

### ç¼“å­˜ç­–ç•¥
- **æ™ºèƒ½æ£€æŸ¥**: å¯åŠ¨æ—¶æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰å›¾ç‰‡
- **å¢é‡ä¸‹è½½**: åªä¸‹è½½ç¼ºå¤±çš„å›¾ç‰‡
- **æŒä¹…åŒ–å­˜å‚¨**: å›¾ç‰‡ä¿å­˜åœ¨ç”¨æˆ·æ•°æ®ç›®å½•
- **è‡ªåŠ¨å›é€€**: æœ¬åœ°å›¾ç‰‡ä¸å¯ç”¨æ—¶ä½¿ç”¨è¿œç¨‹å›¾ç‰‡

## âœ… ä¼˜åŠ¿

1. **æ€§èƒ½æå‡**: 
   - æœ¬åœ°ç¼“å­˜é¿å…é‡å¤ä¸‹è½½
   - æ— éœ€Canvasæ¸²æŸ“ï¼Œç›´æ¥æ˜¾ç¤ºå›¾ç‰‡
   - å¹¶å‘ä¸‹è½½æé«˜åˆå§‹åŒ–é€Ÿåº¦

2. **ç”¨æˆ·ä½“éªŒ**: 
   - æ¸…æ™°çš„ä¸‹è½½è¿›åº¦æç¤º
   - ç¦»çº¿ä½¿ç”¨æœ¬åœ°ç¼“å­˜å›¾ç‰‡
   - è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé‡è¯•

3. **ç»´æŠ¤æ€§**: 
   - äº‘ç«¯å›¾ç‰‡ç»Ÿä¸€ç®¡ç†
   - æ”¯æŒå›¾ç‰‡æ›´æ–°å’Œç‰ˆæœ¬æ§åˆ¶
   - æœ¬åœ°ç¼“å­˜è‡ªåŠ¨ç®¡ç†

4. **æ‰©å±•æ€§**: 
   - æ˜“äºæ·»åŠ æ–°çš„éŸ³ç¬¦å’Œè°±å·
   - æ”¯æŒä¸åŒå›¾ç‰‡è´¨é‡å’Œå°ºå¯¸
   - å¯æ‰©å±•åˆ°å…¶ä»–ä¹å™¨

## ğŸ› ï¸ å¼€å‘è°ƒè¯•

### è·å–ä¸‹è½½çŠ¶æ€
```javascript
const app = getApp()
const progress = app.getImageDownloadProgress()
console.log('ä¸‹è½½è¿›åº¦:', progress)
```

### è·å–å›¾ç‰‡è·¯å¾„
```javascript
const imageManager = app.getImageManager()
const imagePath = imageManager.getLocalImagePath('C4', 'treble')
console.log('å›¾ç‰‡è·¯å¾„:', imagePath)
```

### æ¸…ç†ç¼“å­˜
```javascript
await imageManager.clearCache()
await imageManager.initialize()
```

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
miniprogram/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ imageManager.js         # å›¾ç‰‡ç®¡ç†å™¨
â”œâ”€â”€ components/staff-image/
â”‚   â”œâ”€â”€ staff-image.js          # äº”çº¿è°±å›¾ç‰‡ç»„ä»¶
â”‚   â”œâ”€â”€ staff-image.wxml
â”‚   â””â”€â”€ staff-image.wxss
â””â”€â”€ pages/test-staff/           # æµ‹è¯•é¡µé¢
    â”œâ”€â”€ test-staff.js
    â”œâ”€â”€ test-staff.wxml
    â”œâ”€â”€ test-staff.wxss
    â””â”€â”€ test-staff.json
```

### ä¿®æ”¹æ–‡ä»¶
```
miniprogram/
â”œâ”€â”€ app.js                      # æ·»åŠ å›¾ç‰‡åˆå§‹åŒ–
â”œâ”€â”€ pages/index/                # æ·»åŠ ä¸‹è½½çŠ¶æ€æ˜¾ç¤º
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ index.wxml
â”‚   â””â”€â”€ index.wxss
â””â”€â”€ pages/learning/             # ä½¿ç”¨æ–°çš„å›¾ç‰‡ç»„ä»¶
    â”œâ”€â”€ learning.wxml
    â””â”€â”€ learning.json
```

### åˆ é™¤æ–‡ä»¶
```
miniprogram/
â””â”€â”€ äº”çº¿è°±/                     # åˆ é™¤æœ¬åœ°å›¾ç‰‡ç›®å½•
    â”œâ”€â”€ treble_*.png (å·²åˆ é™¤)
    â””â”€â”€ bass_*.png (å·²åˆ é™¤)
```

## ğŸ‰ å®ŒæˆçŠ¶æ€

âœ… å›¾ç‰‡ç®¡ç†å™¨åˆ›å»ºå®Œæˆ  
âœ… äº‘ç«¯å›¾ç‰‡é…ç½®å®Œæˆ  
âœ… ç»„ä»¶æ”¹é€ å®Œæˆ  
âœ… åº”ç”¨å¯åŠ¨æµç¨‹å®Œæˆ  
âœ… ç”¨æˆ·ç•Œé¢æ”¹è¿›å®Œæˆ  
âœ… æµ‹è¯•é¡µé¢åˆ›å»ºå®Œæˆ  
âœ… æœ¬åœ°å›¾ç‰‡æ¸…ç†å®Œæˆ  
âœ… æ–‡æ¡£æ›´æ–°å®Œæˆ  

ç°åœ¨å°ç¨‹åºä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ä»äº‘ç«¯ä¸‹è½½æ‰€æœ‰äº”çº¿è°±å›¾ç‰‡åˆ°æœ¬åœ°ç¼“å­˜ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°ä¸‹è½½è¿›åº¦ï¼Œä¸‹è½½å®Œæˆåå³å¯æ­£å¸¸ä½¿ç”¨å­¦ä¹ åŠŸèƒ½ï¼ 