<view class="container">
  <view class="learning-content">
    <text class="title"> {{pageTitle}}</text>
    
    <!-- æ¸¸æˆä¿¡æ¯ -->
    <view class="game-info card">
      <view class="info-row">
        <text class="label">æ¨¡å¼:</text>
        <text class="value">{{gameModeText}}</text>
      </view>
      <view class="info-row">
        <text class="label">è¿›åº¦:</text>
        <text class="value">{{progressText}}</text>
      </view>
      <view wx:if="{{gameMode === 'pk'}}" class="info-row">
        <text class="label">å½“å‰ç©å®¶:</text>
        <text class="value">ç©å®¶{{currentPlayer}}</text>
      </view>
    </view>
    
    <!-- äº”çº¿è°±å’Œç®€è°±æ˜¾ç¤ºåŒºåŸŸ -->
    <view class="note-display">
      <view class="staff-area card">
        <text class="area-title">äº”çº¿è°± ({{currentNote ? (currentNote.clef === 'treble' ? 'é«˜éŸ³ç¬¦å·' : 'ä½éŸ³ç¬¦å·') : 'å›¾ç‰‡æ¸²æŸ“'}})</text>
        <staff-image note="{{currentNote}}" clef="{{currentNote ? currentNote.clef : 'treble'}}" />
      </view>
      
      <view class="jianpu-area card">
        <text class="area-title">ç®€è°±</text>
        <jianpu note="{{currentNote}}" show="{{hasShownJianpu}}" />
      </view>
    </view>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <view class="controls">
      <button 
        wx:if="{{!hasShownJianpu}}"
        class="btn btn-primary control-btn" 
        disabled="{{!selectedKey}}"
        bindtap="confirmAnswer"
      >
        ç¡®è®¤ç­”æ¡ˆ
      </button>
      <button 
        wx:if="{{hasShownJianpu && !isGameCompleted}}"
        class="btn btn-primary control-btn" 
        bindtap="nextQuestion"
      >
        ä¸‹ä¸€é¢˜
      </button>
      <button 
        wx:if="{{isGameCompleted}}"
        class="btn btn-primary control-btn" 
        bindtap="showSummary"
      >
        æŸ¥çœ‹æ€»ç»“
      </button>
      <button class="btn btn-exit control-btn" bindtap="handleEndGame">{{endButtonText}}</button>
    </view>
    
    <!-- é’¢ç´é”®ç›˜ -->
    <view class="piano-area card" style="padding: 5px;">
      <piano style="padding: 0%;" 
        selectedKey="{{selectedKey}}" 
        highlightKey="{{currentNote ? currentNote.pianoKey : ''}}"
        showAnswer="{{hasShownJianpu}}"
        bind:keyselect="selectKey"
      />
    </view>
  </view>
  
  <!-- å­¦ä¹ æ€»ç»“å¼¹çª— -->
  <view wx:if="{{showSummaryModal}}" class="modal">
    <view class="modal-content">
      <view class="summary-header">
        <view class="summary-icon celebration-emoji">ğŸ‰</view>
        <text class="summary-title">{{gameMode === 'pk' ? 'PKå¯¹æˆ˜æ€»ç»“' : 'å­¦ä¹ æ€»ç»“'}}</text>
      </view>
      
      <view wx:if="{{gameMode !== 'pk'}}" class="summary-stats">
        <view class="stat-item">
          <view class="stat-icon">ğŸ“Š</view>
          <view class="stat-label">æ€»é¢˜æ•°</view>
          <view class="stat-value">{{totalQuestions}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-icon">âœ…</view>
          <view class="stat-label">æ­£ç¡®æ•°</view>
          <view class="stat-value correct">{{correctAnswers}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-icon">âŒ</view>
          <view class="stat-label">é”™è¯¯æ•°</view>
          <view class="stat-value wrong">{{wrongAnswers}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-icon">ğŸ¯</view>
          <view class="stat-label">æ­£ç¡®ç‡</view>
          <view class="stat-value">{{accuracyRate}}%</view>
        </view>
        <view class="stat-item">
          <view class="stat-icon">â±ï¸</view>
          <view class="stat-label">å¹³å‡ååº”æ—¶é—´</view>
          <view class="stat-value">{{averageReactionTime}}ç§’</view>
        </view>
      </view>
      
      <!-- PKæ¨¡å¼å¯¹æ¯” -->
      <view wx:if="{{gameMode === 'pk'}}" class="pk-comparison">
        <view class="pk-stats-grid">
          <view class="pk-stat-row">
            <view class="stat-header">æ­£ç¡®ç‡</view>
            <view class="player-stat">
              <text wx:if="{{player1AccuracyRate > player2AccuracyRate}}" class="crown">ğŸ‘‘</text>
              {{player1AccuracyRate}}%
            </view>
            <view class="vs-divider">VS</view>
            <view class="player-stat">
              <text wx:if="{{player2AccuracyRate > player1AccuracyRate}}" class="crown">ğŸ‘‘</text>
              {{player2AccuracyRate}}%
            </view>
          </view>
          
          <view class="pk-stat-row">
            <view class="stat-header">å¹³å‡æ—¶é—´</view>
            <view class="player-stat">
              <text wx:if="{{player1AverageReactionTime < player2AverageReactionTime && player1AverageReactionTime > 0}}" class="crown">ğŸ‘‘</text>
              {{player1AverageReactionTime}}ç§’
            </view>
            <view class="vs-divider">VS</view>
            <view class="player-stat">
              <text wx:if="{{player2AverageReactionTime < player1AverageReactionTime && player2AverageReactionTime > 0}}" class="crown">ğŸ‘‘</text>
              {{player2AverageReactionTime}}ç§’
            </view>
          </view>
        </view>
        
        <view class="final-winner">
          {{winnerText}}
        </view>
      </view>
      
      <view class="summary-actions">
        <button class="btn btn-confirm" bindtap="restartGame">å†æ¥ä¸€æ¬¡</button>
        <button class="btn btn-exit" bindtap="closeSummaryAndGoBack">è¿”å›é¦–é¡µ</button>
      </view>
    </view>
  </view>
  
  <!-- ç¡®è®¤é€€å‡ºå¼¹çª— -->
  <view wx:if="{{showExitConfirm}}" class="modal">
    <view class="modal-content exit-modal-content">
      <view class="exit-header">
        <view class="exit-icon thinking-emoji">ğŸ¤”</view>
        <text class="exit-title">{{gameMode === 'pk' ? 'ç¡®è®¤é€€å‡ºPKï¼Ÿ' : 'ç¡®è®¤é€€å‡ºå­¦ä¹ ï¼Ÿ'}}</text>
      </view>
      <view class="exit-progress">
        <view class="progress-circle">
          <view class="progress-number">{{progressNumberText}}</view>
          <view class="progress-label">å·²å®Œæˆé¢˜æ•°</view>
        </view>
      </view>
      <view class="exit-actions">
        <button class="btn btn-confirm" bindtap="exitWithReport">ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š</button>
        <button class="btn btn-continue" bindtap="cancelExit">ğŸ’ª {{gameMode === 'pk' ? 'ç»§ç»­PK' : 'ç»§ç»­å­¦ä¹ '}}</button>
        <button class="btn btn-exit" bindtap="exitDirectly">ğŸšª ç›´æ¥é€€å‡º</button>
      </view>
    </view>
  </view>
</view> 