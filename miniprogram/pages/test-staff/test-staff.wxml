<!--pages/test-staff/test-staff.wxml-->
<view class="container">
  <view class="test-content">
    <text class="title">🎼 五线谱图片测试</text>
    
    <!-- 图片下载状态 -->
    <view class="download-info">
      <text class="info-text">图片下载状态：{{imageDownloadStatus.isCompleted ? '已完成' : '未完成'}}</text>
      <text class="info-text" wx:if="{{imageDownloadStatus.error}}">错误：{{imageDownloadStatus.error}}</text>
      <text class="info-text">总图片数量：{{totalCount}} 张</text>
    </view>

    <!-- 谱号切换 -->
    <view class="clef-filter">
      <text class="section-title">谱号过滤</text>
      <view class="clef-options">
        <view 
          class="clef-option {{currentClef === 'treble' ? 'active' : ''}}"
          bindtap="switchClef"
          data-clef="treble"
        >
          高音符号 ({{trebleCount}})
        </view>
        <view 
          class="clef-option {{currentClef === 'bass' ? 'active' : ''}}"
          bindtap="switchClef"
          data-clef="bass"
        >
          低音符号 ({{bassCount}})
        </view>
        <view 
          class="clef-option {{currentClef === 'all' ? 'active' : ''}}"
          bindtap="switchClef"
          data-clef="all"
        >
          全部 ({{totalCount}})
        </view>
      </view>
    </view>

    <!-- 当前音符信息 -->
    <view class="current-note" wx:if="{{currentNote}}">
      <text class="note-title">当前音符：{{currentNote.name}} ({{currentNote.clef === 'treble' ? '高音' : '低音'}}符号)</text>
      <text class="note-info">谱号：{{currentNote.clef === 'treble' ? '高音符号' : '低音符号'}}</text>
      <text class="note-info">位置：{{currentNote.position}}</text>
      <text class="note-info">简谱：{{currentNote.jianpu}}</text>
      <text class="note-info">文件名：{{currentNote.fileName}}</text>
      <text class="note-info">当前索引：{{currentNoteIndex + 1}} / {{totalCount}}</text>
    </view>

    <!-- 五线谱显示区域 -->
    <view class="staff-container" wx:if="{{currentNote}}">
      <staff-image 
        note="{{currentNote}}" 
        clef="{{currentNote.clef}}"
      />
    </view>

    <!-- 直接图片测试 -->
    <view class="direct-image-test" wx:if="{{currentNote}}">
      <text class="section-title">直接图片测试</text>
      <image 
        class="test-image" 
        src="{{testImagePath}}"
        mode="aspectFit"
        binderror="onImageError"
        bindload="onImageLoad"
      />
      <text class="image-path">路径：{{testImagePath}}</text>
    </view>

    <!-- 控制按钮 -->
    <view class="controls">
      <button class="btn btn-secondary" bindtap="prevNote">← 上一个</button>
      <text class="control-info">{{currentNoteIndex + 1}} / {{totalCount}}</text>
      <button class="btn btn-secondary" bindtap="nextNote">下一个 →</button>
    </view>

    <!-- 调试按钮 -->
    <view class="debug-controls">
      <button class="btn btn-secondary debug-btn" bindtap="debugImageManager">打印调试信息</button>
      <button class="btn btn-secondary debug-btn" bindtap="checkCurrentImage">检查当前图片</button>
    </view>

    <!-- 音符列表 -->
    <view class="note-list">
      <text class="section-title">音符列表 ({{currentClef === 'all' ? '全部' : (currentClef === 'treble' ? '高音符号' : '低音符号')}})</text>
      <view class="notes">
        <view 
          wx:for="{{filteredNotes}}" 
          wx:key="fileName"
          class="note-item {{currentNote && currentNote.fileName === item.fileName ? 'active' : ''}}"
          bindtap="selectNote"
          data-index="{{item.selectIndex}}"
        >
          <view class="note-name">{{item.name}}</view>
          <view class="note-clef">{{item.clef === 'treble' ? '高音' : '低音'}}</view>
          <view class="note-position">{{item.position}}</view>
        </view>
      </view>
    </view>
  </view>
</view>