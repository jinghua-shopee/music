/**
 * å¾®ä¿¡å°ç¨‹åºéŸ³é¢‘å·¥å…·ç±»
 * ä½¿ç”¨ wx.createInnerAudioContext() æ’­æ”¾éŸ³é¢‘
 */

const { pianoKeyMapping } = require('./pianoKeyMapping.js')
const audioDownloadManager = require('./audioDownloadManager.js')

class AudioManager {
  constructor() {
    this.audioPool = new Map() // éŸ³é¢‘å¯¹è±¡æ± 
    this.isAudioEnabled = true
    this.maxAudioInstances = 15 // å¢åŠ æœ€å¤§åŒæ—¶æ’­æ”¾æ•°é‡
    this.preloadLevel = 'common' // é¢„åŠ è½½çº§åˆ«: essential, common, extended, full
    this.hasUserInteraction = false // è®°å½•æ˜¯å¦æœ‰ç”¨æˆ·äº¤äº’
    this.isWarmedUp = false // è®°å½•æ˜¯å¦å·²é¢„çƒ­
    
    // éŸ³ç¬¦é¢‘ç‡æ˜ å°„ï¼ˆæ‰©å±•åˆ°88é”®ï¼‰
    this.noteFrequencies = this.generateNoteFrequencies()
    
    this.init()
  }

  // ç”Ÿæˆ88é”®é’¢ç´éŸ³ç¬¦é¢‘ç‡æ˜ å°„
  generateNoteFrequencies() {
    const frequencies = {}
    const fullRange = pianoKeyMapping.getFullRange()
    
    // A4 = 440Hzä½œä¸ºå‚è€ƒï¼Œè®¡ç®—å…¶ä»–éŸ³ç¬¦é¢‘ç‡
    const A4_FREQ = 440
    const A4_INDEX = pianoKeyMapping.getFileByNoteKey('a4').index
    
    Object.entries(fullRange).forEach(([noteKey, noteInfo]) => {
      // è®¡ç®—ä¸A4çš„åŠéŸ³è·ç¦»
      const semitonesFromA4 = noteInfo.index - A4_INDEX
      // é¢‘ç‡å…¬å¼: f = f0 * 2^(n/12)
      const frequency = A4_FREQ * Math.pow(2, semitonesFromA4 / 12)
      frequencies[noteKey] = Math.round(frequency * 100) / 100 // ä¿ç•™2ä½å°æ•°
    })
    
    return frequencies
  }

  // åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨
  init() {
    console.log('ğŸµ éŸ³é¢‘ç®¡ç†å™¨åˆå§‹åŒ– (æ”¯æŒ88é”®é’¢ç´)')
    
    // æ£€æŸ¥éŸ³é¢‘æƒé™
    this.checkAudioPermission()
    
    // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
    this.initAudioContext()
    
    // æ ¹æ®é¢„åŠ è½½çº§åˆ«é¢„åŠ è½½éŸ³ç¬¦
    this.preloadNotesByLevel()
    
    // éŸ³é¢‘é¢„çƒ­
    this.warmupAudio()
    
    // å»¶è¿ŸæŠ¥å‘ŠåŠ è½½çŠ¶æ€
    setTimeout(() => {
      this.reportLoadingStatus()
    }, 2000)
  }

  // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆè§£å†³çœŸæœºæ’­æ”¾é—®é¢˜ï¼‰
  initAudioContext() {
    // åˆ›å»ºä¸€ä¸ªé™éŸ³éŸ³é¢‘æ¥æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
    try {
      const audio = wx.createInnerAudioContext()
      audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LHdSEFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAcBzuVz+zGbyECLHXE7+5VGQs' 
      audio.volume = 0
      audio.play()
      audio.onEnded(() => {
        audio.destroy()
      })
      console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  // æ£€æŸ¥éŸ³é¢‘æƒé™
  checkAudioPermission() {
    wx.getSetting({
      success: (res) => {
        console.log('éŸ³é¢‘æƒé™æ£€æŸ¥å®Œæˆ')
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æˆæƒ
        if (res.authSetting['scope.record'] === false) {
          console.warn('ç”¨æˆ·æ‹’ç»äº†å½•éŸ³æƒé™ï¼Œå¯èƒ½å½±å“éŸ³é¢‘æ’­æ”¾')
        }
      },
      fail: (error) => {
        console.warn('æƒé™æ£€æŸ¥å¤±è´¥:', error)
      }
    })
  }

  // æ ¹æ®çº§åˆ«é¢„åŠ è½½éŸ³ç¬¦
  preloadNotesByLevel() {
    const suggestions = pianoKeyMapping.getPreloadSuggestions()
    let notesToPreload = []
    
    switch (this.preloadLevel) {
      case 'essential':
        notesToPreload = suggestions.essential
        console.log('ğŸ¹ é¢„åŠ è½½æ ¸å¿ƒéŸ³ç¬¦ (8ä¸ª):', notesToPreload)
        break
      case 'common':
        notesToPreload = Object.keys(suggestions.common)
        console.log('ğŸ¹ é¢„åŠ è½½å¸¸ç”¨éŸ³ç¬¦ (36ä¸ª):', notesToPreload.slice(0, 10), '...ç­‰')
        break
      case 'extended':
        notesToPreload = Object.keys(suggestions.extended)
        console.log('ğŸ¹ é¢„åŠ è½½æ‰©å±•éŸ³ç¬¦ (73ä¸ª):', notesToPreload.slice(0, 10), '...ç­‰')
        break
      case 'full':
        notesToPreload = Object.keys(suggestions.full)
        console.log('ğŸ¹ é¢„åŠ è½½å…¨éƒ¨éŸ³ç¬¦ (88ä¸ª):', notesToPreload.slice(0, 10), '...ç­‰')
        break
      default:
        notesToPreload = suggestions.essential
        console.log('ğŸ¹ é»˜è®¤é¢„åŠ è½½æ ¸å¿ƒéŸ³ç¬¦:', notesToPreload)
    }
    
    // éªŒè¯éŸ³ç¬¦åˆ—è¡¨
    const invalidNotes = notesToPreload.filter(noteKey => 
      !noteKey || !noteKey.match(/^[a-g]#?[0-8]$/)
    )
    
    if (invalidNotes.length > 0) {
      console.error('âŒ å‘ç°æ— æ•ˆçš„é¢„åŠ è½½éŸ³ç¬¦:', invalidNotes)
      // è¿‡æ»¤æ‰æ— æ•ˆéŸ³ç¬¦
      notesToPreload = notesToPreload.filter(noteKey => 
        noteKey && noteKey.match(/^[a-g]#?[0-8]$/)
      )
    }
    
    console.log(`ğŸ“ å®é™…é¢„åŠ è½½éŸ³ç¬¦æ•°é‡: ${notesToPreload.length}`)
    
    // åˆ†æ‰¹é¢„åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤š
    this.batchPreload(notesToPreload)
  }

  // åˆ†æ‰¹é¢„åŠ è½½éŸ³ç¬¦
  batchPreload(noteKeys, batchSize = 10, delay = 100) {
    const batches = []
    for (let i = 0; i < noteKeys.length; i += batchSize) {
      batches.push(noteKeys.slice(i, i + batchSize))
    }
    
    batches.forEach((batch, index) => {
      setTimeout(() => {
        batch.forEach(noteKey => {
          this.preloadNote(noteKey)
        })
        console.log(`ğŸµ é¢„åŠ è½½æ‰¹æ¬¡ ${index + 1}/${batches.length} å®Œæˆ`)
      }, index * delay)
    })
  }

  // é¢„åŠ è½½å•ä¸ªéŸ³ç¬¦
  preloadNote(noteKey) {
    return new Promise((resolve) => {
      if (this.audioPool.has(noteKey)) {
        console.log(`éŸ³ç¬¦ ${noteKey} å·²é¢„åŠ è½½`)
        resolve(this.audioPool.get(noteKey))
        return
      }

      console.log(`ğŸµ å¼€å§‹é¢„åŠ è½½éŸ³ç¬¦: ${noteKey}`)

      // éªŒè¯éŸ³ç¬¦é”®åæ ¼å¼
      if (!noteKey || typeof noteKey !== 'string' || !noteKey.match(/^[a-g]#?[0-8]$/)) {
        console.error(`âŒ æ— æ•ˆçš„éŸ³ç¬¦é”®åæ ¼å¼: "${noteKey}"`)
        this.audioPool.set(noteKey, null)
        resolve(null)
        return
      }

      const audioUrl = this.getAudioUrl(noteKey)
      
      // å¦‚æœæ²¡æœ‰éŸ³é¢‘æ–‡ä»¶ï¼Œç›´æ¥æ ‡è®°ä¸ºæ— éŸ³é¢‘æ¨¡å¼
      if (!audioUrl) {
        this.audioPool.set(noteKey, null)
        console.log(`éŸ³ç¬¦ ${noteKey} ä½¿ç”¨æŒ¯åŠ¨æ¨¡å¼`)
        resolve(null)
        return
      }

      // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯å¸¦#å·çš„éŸ³ç¬¦ä¸”URLåŒ…å«#å·ï¼Œå…ˆå°è¯•åˆ›å»ºå®‰å…¨å‰¯æœ¬
      if (noteKey.includes('#') && audioUrl.includes('#')) {
        console.log(`ğŸ”§ æ£€æµ‹åˆ°å¸¦#å·éŸ³ç¬¦ï¼Œå°è¯•å®‰å…¨å¤„ç†: ${noteKey}`)
        
        // å…ˆå°è¯•è·å–å®‰å…¨å‰¯æœ¬è·¯å¾„
        const audioDownloadManager = require('./audioDownloadManager')
        const safePath = audioDownloadManager.createSafeFileCopy(audioUrl, noteKey)
        
        if (safePath && safePath !== audioUrl) {
          console.log(`ğŸ¯ ä½¿ç”¨å®‰å…¨å‰¯æœ¬è·¯å¾„: ${noteKey} -> ${safePath}`)
          this.preloadNoteWithUrl(noteKey, safePath).then(resolve)
          return
        }
      }

      this.preloadNoteWithUrl(noteKey, audioUrl).then(resolve)
    })
  },

  // ä½¿ç”¨æŒ‡å®šURLé¢„åŠ è½½éŸ³ç¬¦
  preloadNoteWithUrl(noteKey, audioUrl) {
    return new Promise((resolve) => {
      console.log(`ğŸµ éŸ³ç¬¦ ${noteKey} éŸ³é¢‘URL: ${audioUrl}`)

      // åˆ›å»ºéŸ³é¢‘å®ä¾‹
      const audio = wx.createInnerAudioContext()
      
      audio.src = audioUrl
      
      // è®¾ç½®éŸ³é¢‘å±æ€§
      audio.volume = 0.8
      audio.loop = false
      audio.autoplay = false
      
      // æ·»åŠ è¶…æ—¶æ£€æµ‹
      let loadTimeout = null
      let isLoaded = false
      let isResolved = false
      
      const resolveOnce = (result) => {
        if (!isResolved) {
          isResolved = true
          resolve(result)
        }
      }
      
      // é”™è¯¯å¤„ç†
      audio.onError((error) => {
        console.warn(`éŸ³é¢‘åŠ è½½å¤±è´¥ ${noteKey}:`, error)
        clearTimeout(loadTimeout)
        
        // åˆ†æé”™è¯¯ç±»å‹
        let errorType = 'unknown'
        if (error.errMsg && error.errMsg.includes('Unable to decode audio data')) {
          errorType = 'decode_error'
          console.error(`ğŸš« éŸ³é¢‘è§£ç å¤±è´¥ ${noteKey}: æ–‡ä»¶å¯èƒ½æŸåæˆ–æ ¼å¼ä¸æ”¯æŒ`)
          
          // è§£ç é”™è¯¯ï¼šæ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥ï¼Œä¸å†é‡è¯•
          this.audioPool.set(noteKey, null)
          console.log(`âš ï¸ éŸ³ç¬¦ ${noteKey} æ°¸ä¹…ä½¿ç”¨æŒ¯åŠ¨åé¦ˆ (è§£ç å¤±è´¥)`)
          resolveOnce(null)
          return
          
        } else if (error.errMsg && error.errMsg.includes('404')) {
          errorType = 'file_not_found'
          console.error(`ğŸ“ éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨ ${noteKey}: ${audioUrl}`)
        } else if (error.errMsg && error.errMsg.includes('network')) {
          errorType = 'network_error'
          console.error(`ğŸŒ ç½‘ç»œé”™è¯¯ ${noteKey}: æ— æ³•ä¸‹è½½éŸ³é¢‘æ–‡ä»¶`)
        }
        
        // åªå¯¹éè§£ç é”™è¯¯è¿›è¡Œé‡è¯•ï¼Œä¸”é™åˆ¶é‡è¯•æ¬¡æ•°
        if (!isLoaded && errorType !== 'decode_error') {
          const retryCount = this.audioPool.get(noteKey + '_retry_count') || 0
          if (retryCount < 2) { // æœ€å¤šé‡è¯•2æ¬¡
            console.log(`ğŸ”„ å°è¯•é‡æ–°åŠ è½½éŸ³ç¬¦: ${noteKey} (é‡è¯• ${retryCount + 1}/2)`)
            this.audioPool.set(noteKey + '_retry_count', retryCount + 1)
            setTimeout(async () => {
              try {
                const result = await this.retryPreloadNote(noteKey)
                resolveOnce(result)
              } catch (retryError) {
                this.audioPool.set(noteKey, null)
                resolveOnce(null)
              }
            }, 1000 * (retryCount + 1)) // é€’å¢å»¶è¿Ÿ
          } else {
            console.log(`âŒ éŸ³ç¬¦ ${noteKey} é‡è¯•æ¬¡æ•°å·²ç”¨å®Œï¼Œä½¿ç”¨æŒ¯åŠ¨åé¦ˆ`)
            this.audioPool.set(noteKey, null)
            resolveOnce(null)
          }
        } else {
          console.log(`âš ï¸ éŸ³ç¬¦ ${noteKey} å°†ä½¿ç”¨æŒ¯åŠ¨åé¦ˆ (é”™è¯¯ç±»å‹: ${errorType})`)
          this.audioPool.set(noteKey, null)
          resolveOnce(null)
        }
      })
      
      // éŸ³é¢‘åŠ è½½å®Œæˆ
      audio.onCanplay(() => {
        isLoaded = true
        clearTimeout(loadTimeout)
        
        // æ¸…é™¤é‡è¯•è®¡æ•°
        this.audioPool.delete(noteKey + '_retry_count')
        
        // åªåœ¨è¯¦ç»†æ¨¡å¼ä¸‹è®°å½•
        if (this.preloadLevel === 'essential') {
          console.log(`éŸ³é¢‘é¢„åŠ è½½å®Œæˆ: ${noteKey}`)
        }
        
        resolveOnce(audio)
      })
      
      // è®¾ç½®åŠ è½½è¶…æ—¶ï¼ˆ5ç§’ï¼‰
      loadTimeout = setTimeout(() => {
        if (!isLoaded && !isResolved) {
          console.warn(`éŸ³é¢‘åŠ è½½è¶…æ—¶ ${noteKey}`)
          audio.destroy()
          this.audioPool.set(noteKey, null)
          resolveOnce(null)
        }
      }, 5000)
      
      this.audioPool.set(noteKey, audio)
    })
  },

  // é‡è¯•é¢„åŠ è½½éŸ³ç¬¦
  retryPreloadNote(noteKey) {
    console.log(`é‡è¯•é¢„åŠ è½½éŸ³ç¬¦: ${noteKey}`)
    
    // æ¸…é™¤æ—§çš„å®ä¾‹
    const oldAudio = this.audioPool.get(noteKey)
    if (oldAudio && typeof oldAudio.destroy === 'function') {
      oldAudio.destroy()
    }
    this.audioPool.delete(noteKey)
    
    // é‡æ–°é¢„åŠ è½½
    const audioUrl = this.getAudioUrl(noteKey)
    if (!audioUrl) {
      this.audioPool.set(noteKey, null)
      return
    }

    const audio = wx.createInnerAudioContext()
    audio.src = audioUrl
    audio.volume = 0.8
    audio.loop = false
    audio.autoplay = false
    
    // ç®€åŒ–çš„é”™è¯¯å¤„ç†ï¼ˆä¸å†é‡è¯•ï¼‰
    audio.onError((error) => {
      console.warn(`éŸ³é¢‘é‡è¯•ä»ç„¶å¤±è´¥ ${noteKey}:`, error)
      this.audioPool.set(noteKey, null)
    })
    
    audio.onCanplay(() => {
      console.log(`éŸ³é¢‘é‡è¯•æˆåŠŸ ${noteKey}`)
    })
    
    this.audioPool.set(noteKey, audio)
  },

  // è·å–éŸ³é¢‘æ–‡ä»¶URL
  getAudioUrl(noteKey) {
    // éªŒè¯éŸ³ç¬¦æ˜¯å¦åœ¨88é”®èŒƒå›´å†…
    const noteInfo = pianoKeyMapping.getFileByNoteKey(noteKey)
    if (!noteInfo) {
      console.warn(`æ— æ•ˆéŸ³ç¬¦: ${noteKey}`)
      return null
    }
    
    // ä¼˜å…ˆä½¿ç”¨ä¸‹è½½çš„éŸ³é¢‘æ–‡ä»¶
    const localPath = audioDownloadManager.getLocalAudioPath(noteKey)
    if (localPath) {
      // éªŒè¯è·¯å¾„æ˜¯å¦å®Œæ•´ï¼ˆåŒ…å«æ–‡ä»¶æ‰©å±•åï¼‰
      if (!localPath.includes('.mp3')) {
        console.error(`âŒ éŸ³é¢‘è·¯å¾„ä¸å®Œæ•´: ${noteKey} -> ${localPath}`)
        return null
      }
      
      // éªŒè¯è·¯å¾„æ˜¯å¦åŒ…å«æ­£ç¡®çš„éŸ³ç¬¦å
      const expectedFileName = `${noteKey}.mp3`
      if (!localPath.includes(expectedFileName)) {
        console.error(`âŒ éŸ³é¢‘è·¯å¾„ä¸åŒ¹é…: ${noteKey} æœŸæœ› ${expectedFileName} ä½†å¾—åˆ° ${localPath}`)
        return null
      }
      
      console.log(`ä½¿ç”¨ä¸‹è½½çš„éŸ³é¢‘æ–‡ä»¶: ${noteKey} -> ${localPath}`)
      return localPath
    }
    
    // å¦‚æœæ²¡æœ‰ä¸‹è½½çš„æ–‡ä»¶ï¼Œç›´æ¥è¿”å›nullï¼Œä½¿ç”¨æŒ¯åŠ¨åé¦ˆ
    console.warn(`éŸ³é¢‘æ–‡ä»¶æœªä¸‹è½½: ${noteKey}ï¼Œå°†ä½¿ç”¨æŒ¯åŠ¨åé¦ˆ`)
    return null
  },

  // æ’­æ”¾éŸ³ç¬¦
  playNote(noteKey, options = {}) {
    if (!this.isAudioEnabled) {
      console.log('éŸ³é¢‘å·²ç¦ç”¨')
      return
    }

    // åœ¨ç”¨æˆ·äº¤äº’æ—¶é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
    if (!this.hasUserInteraction) {
      this.hasUserInteraction = true
      this.reactivateAudioContext()
    }

    const {
      volume = 0.8,
      duration = 500,
      fadeOut = true,
      retry = true
    } = options

    console.log(`æ’­æ”¾éŸ³ç¬¦: ${noteKey}`)

    // æ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥çš„æ°¸ä¹…å¤±è´¥éŸ³ç¬¦
    const retryCount = this.audioPool.get(noteKey + '_retry_count') || 0
    if (retryCount >= 2) {
      console.log(`ğŸš« è·³è¿‡æ’­æ”¾æ°¸ä¹…å¤±è´¥çš„éŸ³ç¬¦: ${noteKey}ï¼Œç›´æ¥ä½¿ç”¨æŒ¯åŠ¨`)
      this.playVibrateNote(noteKey)
      return
    }

    // è·å–æˆ–åˆ›å»ºéŸ³é¢‘å®ä¾‹
    let audio = this.audioPool.get(noteKey)
    if (audio === undefined) {
      // åŠ¨æ€åŠ è½½æœªé¢„åŠ è½½çš„éŸ³ç¬¦
      this.preloadNote(noteKey)
      audio = this.audioPool.get(noteKey)
    }

    // å¦‚æœæ˜¯nullï¼Œè¡¨ç¤ºä½¿ç”¨æŒ¯åŠ¨æ¨¡å¼
    if (audio === null) {
      this.playVibrateNote(noteKey)
      return
    }

    // å¦‚æœä»ç„¶æ²¡æœ‰éŸ³é¢‘å®ä¾‹ï¼Œå›é€€åˆ°æŒ¯åŠ¨
    if (!audio) {
      console.warn(`éŸ³é¢‘å®ä¾‹åˆ›å»ºå¤±è´¥: ${noteKey}`)
      this.playVibrateNote(noteKey)
      return
    }

    try {
      // é‡ç½®éŸ³é¢‘çŠ¶æ€
      audio.seek(0)
      
      // è®¾ç½®éŸ³é‡
      audio.volume = volume
      
      // è®¾ç½®é”™è¯¯å¤„ç†
      audio.onError((error) => {
        console.warn(`éŸ³é¢‘æ’­æ”¾å‡ºé”™ ${noteKey}:`, error)
        
        // å¦‚æœæ˜¯è§£ç é”™è¯¯ï¼Œæ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥
        if (error.errMsg && error.errMsg.includes('Unable to decode audio data')) {
          console.log(`ğŸš« æ’­æ”¾æ—¶å‘ç°è§£ç é”™è¯¯ï¼Œæ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥: ${noteKey}`)
          this.audioPool.set(noteKey + '_retry_count', 3) // è®¾ç½®ä¸ºè¶…è¿‡é‡è¯•ä¸Šé™
          this.audioPool.set(noteKey, null)
          this.playVibrateNote(noteKey)
          return
        }
        
        // å¦‚æœå…è®¸é‡è¯•ï¼Œå°è¯•é‡æ–°åˆ›å»ºéŸ³é¢‘å®ä¾‹
        if (retry && retryCount < 2) {
          console.log(`é‡è¯•æ’­æ”¾éŸ³ç¬¦: ${noteKey}`)
          this.audioPool.delete(noteKey) // åˆ é™¤æœ‰é—®é¢˜çš„å®ä¾‹
          this.preloadNote(noteKey) // é‡æ–°åˆ›å»º
          
          // é€’å½’è°ƒç”¨ï¼Œä½†ä¸å†é‡è¯•
          setTimeout(() => {
            this.playNote(noteKey, { ...options, retry: false })
          }, 100)
        } else {
          // æœ€ç»ˆå›é€€åˆ°æŒ¯åŠ¨
          this.playVibrateNote(noteKey)
        }
      })
      
      // å¼€å§‹æ’­æ”¾
      audio.play()
      
      // å¦‚æœè®¾ç½®äº†æŒç»­æ—¶é—´ï¼Œè‡ªåŠ¨åœæ­¢
      if (duration > 0) {
        setTimeout(() => {
          try {
            if (fadeOut) {
              this.fadeOutAudio(audio, 100)
            } else {
              audio.stop()
            }
          } catch (error) {
            console.warn(`åœæ­¢éŸ³é¢‘å¤±è´¥ ${noteKey}:`, error)
          }
        }, duration)
      }
      
      // åŒæ—¶æä¾›è§¦è§‰åé¦ˆ
      this.playVibrateNote(noteKey)
      
    } catch (error) {
      console.error(`æ’­æ”¾éŸ³ç¬¦å¼‚å¸¸ ${noteKey}:`, error)
      
      // å¦‚æœå…è®¸é‡è¯•
      if (retry && retryCount < 2) {
        console.log(`å¼‚å¸¸é‡è¯•æ’­æ”¾éŸ³ç¬¦: ${noteKey}`)
        this.audioPool.delete(noteKey)
        this.preloadNote(noteKey)
        setTimeout(() => {
          this.playNote(noteKey, { ...options, retry: false })
        }, 100)
      } else {
        this.playVibrateNote(noteKey)
      }
    }
  },

  // é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
  reactivateAudioContext() {
    console.log('ğŸµ ç”¨æˆ·äº¤äº’ï¼Œé‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡')
    
    try {
      // åˆ›å»ºä¸€ä¸ªæµ‹è¯•éŸ³é¢‘æ¥æ¿€æ´»ä¸Šä¸‹æ–‡
      const testAudio = wx.createInnerAudioContext()
      testAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LHdSEFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAcBzuVz+zGbyECLHXE7+5VGQs'
      testAudio.volume = 0
      testAudio.play()
      
      testAudio.onEnded(() => {
        testAudio.destroy()
      })
      
      testAudio.onError(() => {
        testAudio.destroy()
      })
      
      // é‡æ–°åŠ è½½å¤±è´¥çš„éŸ³é¢‘å®ä¾‹
      this.reloadFailedAudio()
      
    } catch (error) {
      console.warn('é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', error)
    }
  },

  // é‡æ–°åŠ è½½å¤±è´¥çš„éŸ³é¢‘å®ä¾‹
  reloadFailedAudio() {
    const failedNotes = []
    const permanentlyFailedNotes = []
    
    // æ‰¾å‡ºæ ‡è®°ä¸ºnullï¼ˆæŒ¯åŠ¨æ¨¡å¼ï¼‰çš„éŸ³ç¬¦
    this.audioPool.forEach((audio, noteKey) => {
      if (audio === null) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ°¸ä¹…å¤±è´¥çš„éŸ³ç¬¦ï¼ˆè§£ç é”™è¯¯ç­‰ï¼‰
        const retryCount = this.audioPool.get(noteKey + '_retry_count') || 0
        if (retryCount >= 2) {
          permanentlyFailedNotes.push(noteKey)
        } else {
          failedNotes.push(noteKey)
        }
      }
    })
    
    if (permanentlyFailedNotes.length > 0) {
      console.log(`ğŸš« è·³è¿‡ ${permanentlyFailedNotes.length} ä¸ªæ°¸ä¹…å¤±è´¥çš„éŸ³é¢‘:`, permanentlyFailedNotes)
    }
    
    if (failedNotes.length > 0) {
      console.log(`ğŸ”„ é‡æ–°åŠ è½½ ${failedNotes.length} ä¸ªå¤±è´¥çš„éŸ³é¢‘:`, failedNotes)
      
      // åˆ†ç±»å¤„ç†ï¼šå¸¦#å·çš„éŸ³ç¬¦å’Œæ™®é€šéŸ³ç¬¦
      const sharpNotes = failedNotes.filter(note => note.includes('#'))
      const normalNotes = failedNotes.filter(note => !note.includes('#'))
      
      if (sharpNotes.length > 0) {
        console.log(`ğŸµ ç‰¹åˆ«å¤„ç† ${sharpNotes.length} ä¸ªå¸¦#å·çš„éŸ³ç¬¦:`, sharpNotes)
      }
      
      failedNotes.forEach((noteKey, index) => {
        // å»¶è¿ŸåŠ è½½ï¼Œé¿å…åŒæ—¶åˆ›å»ºå¤ªå¤šéŸ³é¢‘å®ä¾‹
        setTimeout(() => {
          // æ¸…ç†æ—§çš„å®ä¾‹å’Œé‡è¯•è®¡æ•°
          this.audioPool.delete(noteKey)
          this.audioPool.delete(noteKey + '_retry_count')
          
          // å¯¹å¸¦#å·çš„éŸ³ç¬¦ï¼Œå¼ºåˆ¶é‡æ–°è·å–å®‰å…¨è·¯å¾„
          if (noteKey.includes('#')) {
            console.log(`ğŸ”§ é‡æ–°å¤„ç†å¸¦#å·éŸ³ç¬¦: ${noteKey}`)
          }
          
          this.preloadNote(noteKey)
        }, index * 300) // å¢åŠ å»¶è¿Ÿæ—¶é—´
      })
    } else {
      console.log(`âœ… æ²¡æœ‰éœ€è¦é‡æ–°åŠ è½½çš„éŸ³é¢‘æ–‡ä»¶`)
    }
  },

  // æ¸å‡ºæ•ˆæœ
  fadeOutAudio(audio, duration = 200) {
    const startVolume = audio.volume
    const stepTime = 50
    const steps = duration / stepTime
    const volumeStep = startVolume / steps
    
    let currentStep = 0
    const fadeInterval = setInterval(() => {
      currentStep++
      const newVolume = Math.max(0, startVolume - (volumeStep * currentStep))
      audio.volume = newVolume
      
      if (currentStep >= steps || newVolume <= 0) {
        clearInterval(fadeInterval)
        audio.stop()
        audio.volume = startVolume // æ¢å¤åŸå§‹éŸ³é‡
      }
    }, stepTime)
  },

  // ä½¿ç”¨æŒ¯åŠ¨æ¨¡æ‹ŸéŸ³ç¬¦ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  playVibrateNote(noteKey) {
    if (!noteKey) return
    
    const frequency = this.noteFrequencies[noteKey] || 440
    
    // æ ¹æ®é¢‘ç‡è°ƒæ•´æŒ¯åŠ¨æ¨¡å¼
    if (frequency < 130) {
      // æä½éŸ³ - é•¿æŒ¯åŠ¨
      wx.vibrateLong()
    } else if (frequency < 260) {
      // ä½éŸ³ - é•¿æŒ¯åŠ¨
      wx.vibrateLong()
    } else if (frequency > 1000) {
      // é«˜éŸ³ - çŸ­æŒ¯åŠ¨
      wx.vibrateShort()
    } else {
      // ä¸­éŸ³ - çŸ­æŒ¯åŠ¨
      wx.vibrateShort()
    }
  },

  // æ’­æ”¾å’Œå¼¦
  playChord(noteKeys, options = {}) {
    noteKeys.forEach((noteKey, index) => {
      setTimeout(() => {
        this.playNote(noteKey, options)
      }, index * 50) // é”™å¼€50msæ’­æ”¾
    })
  },

  // æ’­æ”¾éŸ³é˜¶
  playScale(noteKeys, options = {}) {
    const { interval = 300 } = options
    
    noteKeys.forEach((noteKey, index) => {
      setTimeout(() => {
        this.playNote(noteKey, options)
      }, index * interval)
    })
  },

  // è®¾ç½®é¢„åŠ è½½çº§åˆ«
  setPreloadLevel(level) {
    const validLevels = ['essential', 'common', 'extended', 'full']
    if (!validLevels.includes(level)) {
      console.warn('æ— æ•ˆçš„é¢„åŠ è½½çº§åˆ«:', level)
      return
    }
    
    this.preloadLevel = level
    console.log(`è®¾ç½®é¢„åŠ è½½çº§åˆ«ä¸º: ${level}`)
    
    // æ¸…ç†å½“å‰é¢„åŠ è½½çš„éŸ³é¢‘
    this.clearAudioPool()
    
    // é‡æ–°é¢„åŠ è½½
    this.preloadNotesByLevel()
  },

  // æ¸…ç†éŸ³é¢‘æ± 
  clearAudioPool() {
    this.audioPool.forEach((audio) => {
      if (audio && typeof audio.destroy === 'function') {
        audio.destroy()
      }
    })
    this.audioPool.clear()
  },

  // åœæ­¢æ‰€æœ‰éŸ³é¢‘
  stopAll() {
    this.audioPool.forEach((audio, noteKey) => {
      try {
        if (audio && typeof audio.stop === 'function') {
          audio.stop()
        }
      } catch (error) {
        console.warn(`åœæ­¢éŸ³é¢‘å¤±è´¥ ${noteKey}:`, error)
      }
    })
  },

  // è®¾ç½®å…¨å±€éŸ³é‡
  setVolume(volume) {
    this.audioPool.forEach((audio) => {
      if (audio && typeof audio.volume !== 'undefined') {
        audio.volume = Math.max(0, Math.min(1, volume))
      }
    })
  },

  // å¯ç”¨/ç¦ç”¨éŸ³é¢‘
  setAudioEnabled(enabled) {
    this.isAudioEnabled = enabled
    if (!enabled) {
      this.stopAll()
    }
    console.log(`éŸ³é¢‘${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`)
  },

  // é”€æ¯éŸ³é¢‘ç®¡ç†å™¨
  destroy() {
    this.stopAll()
    this.clearAudioPool()
    console.log('éŸ³é¢‘ç®¡ç†å™¨å·²é”€æ¯')
  },

  // æŠ¥å‘ŠéŸ³é¢‘åŠ è½½çŠ¶æ€
  reportLoadingStatus() {
    console.log('=== ğŸ¹ éŸ³é¢‘åŠ è½½çŠ¶æ€æŠ¥å‘Š ===')
    
    let audioCount = 0
    let vibrateCount = 0
    const suggestions = pianoKeyMapping.getPreloadSuggestions()
    
    this.audioPool.forEach((audio, noteKey) => {
      if (audio === null) {
        vibrateCount++
      } else if (audio) {
        audioCount++
      }
    })
    
    console.log(`ğŸ“Š å½“å‰é¢„åŠ è½½çº§åˆ«: ${this.preloadLevel}`)
    console.log(`ğŸ“Š éŸ³é¢‘æ–‡ä»¶: ${audioCount} ä¸ª`)
    console.log(`ğŸ“Š æŒ¯åŠ¨æ¨¡å¼: ${vibrateCount} ä¸ª`)
    console.log(`ğŸ“Š æ€»è®¡é¢„åŠ è½½: ${this.audioPool.size} ä¸ªéŸ³ç¬¦`)
    console.log(`ğŸ“Š 88é”®æ€»æ•°: ${Object.keys(suggestions.full).length} ä¸ª`)
    
    if (audioCount > 0) {
      console.log('ğŸ‰ éŸ³é¢‘æ–‡ä»¶åŠ è½½æˆåŠŸï¼æ”¯æŒ88é”®é’¢ç´éŸ³æ•ˆï¼')
    } else {
      console.log('â„¹ï¸  å½“å‰ä½¿ç”¨æŒ¯åŠ¨åé¦ˆæ¨¡å¼')
    }
    
    // æ˜¾ç¤ºé¢„åŠ è½½çº§åˆ«è¯´æ˜
    console.log('\nğŸ’¡ é¢„åŠ è½½çº§åˆ«è¯´æ˜:')
    console.log('- essential: 8ä¸ªæ ¸å¿ƒéŸ³ç¬¦ (ä¸­å¤®CåŒºåŸŸ)')
    console.log('- common: 36ä¸ªå¸¸ç”¨éŸ³ç¬¦ (C3-B5)')
    console.log('- extended: 73ä¸ªæ‰©å±•éŸ³ç¬¦ (C2-C7)')
    console.log('- full: 88ä¸ªå®Œæ•´éŸ³ç¬¦ (A0-C8)')
  },

  // è·å–éŸ³ç¬¦ä¿¡æ¯
  getNoteInfo(noteKey) {
    return pianoKeyMapping.getFileByNoteKey(noteKey)
  },

  // è·å–éŸ³ç¬¦é¢‘ç‡
  getNoteFrequency(noteKey) {
    return this.noteFrequencies[noteKey] || 440
  },

  // å¥åº·æ£€æŸ¥å’Œæ€§èƒ½ç›‘æ§
  async performHealthCheck() {
    console.log('ğŸ” æ‰§è¡ŒéŸ³é¢‘ç³»ç»Ÿå¥åº·æ£€æŸ¥...')
    
    const checkResult = {
      audioContextActive: false,
      downloadManagerHealth: null,
      audioPoolStatus: null,
      recommendations: []
    }
    
    try {
      // 1. æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€
      checkResult.audioContextActive = this.isAudioEnabled
      
      // 2. æ£€æŸ¥ä¸‹è½½ç®¡ç†å™¨å¥åº·çŠ¶æ€
      const audioDownloadManager = require('./audioDownloadManager')
      checkResult.downloadManagerHealth = await audioDownloadManager.performHealthCheck()
      
      // 3. æ£€æŸ¥éŸ³é¢‘æ± çŠ¶æ€
      checkResult.audioPoolStatus = this.getAudioPoolStatus()
      
      // 4. ç”Ÿæˆå»ºè®®
      if (checkResult.downloadManagerHealth.percentage < 80) {
        checkResult.recommendations.push('éŸ³é¢‘æ–‡ä»¶ä¸‹è½½ä¸å®Œæ•´ï¼Œå»ºè®®é‡æ–°ä¸‹è½½')
      }
      
      if (checkResult.audioPoolStatus.nullCount > 10) {
        checkResult.recommendations.push('è¿‡å¤šéŸ³é¢‘å®ä¾‹åˆ›å»ºå¤±è´¥ï¼Œå»ºè®®é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡')
      }
      
      if (!checkResult.audioContextActive) {
        checkResult.recommendations.push('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªæ¿€æ´»ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’åé‡æ–°æ¿€æ´»')
      }
      
      console.log('ğŸ“Š éŸ³é¢‘ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ:', checkResult)
      return checkResult
      
    } catch (error) {
      console.error('éŸ³é¢‘ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥:', error)
      checkResult.error = error.message
      return checkResult
    }
  },

  // è·å–éŸ³é¢‘æ± çŠ¶æ€
  getAudioPoolStatus() {
    let validCount = 0
    let nullCount = 0
    let errorCount = 0
    
    this.audioPool.forEach((audio, noteKey) => {
      if (audio === null) {
        nullCount++
      } else if (audio && typeof audio.play === 'function') {
        validCount++
      } else {
        errorCount++
      }
    })
    
    return {
      total: this.audioPool.size,
      valid: validCount,
      null: nullCount,
      error: errorCount,
      healthScore: Math.round((validCount / this.audioPool.size) * 100)
    }
  },

  // æ™ºèƒ½ä¿®å¤éŸ³é¢‘ç³»ç»Ÿ
  async performSmartRepair() {
    console.log('ğŸ”§ å¼€å§‹æ™ºèƒ½ä¿®å¤éŸ³é¢‘ç³»ç»Ÿ...')
    
    const healthCheck = await this.performHealthCheck()
    const repairActions = []
    
    try {
      // 1. ä¿®å¤ä¸‹è½½ç®¡ç†å™¨é—®é¢˜
      if (healthCheck.downloadManagerHealth && healthCheck.downloadManagerHealth.failed > 0) {
        console.log('ğŸ”„ ä¿®å¤éŸ³é¢‘ä¸‹è½½é—®é¢˜...')
        const audioDownloadManager = require('./audioDownloadManager')
        await audioDownloadManager.retryFailedDownloads()
        repairActions.push('é‡æ–°ä¸‹è½½å¤±è´¥çš„éŸ³é¢‘æ–‡ä»¶')
      }
      
      // 2. æ¸…ç†å’Œé‡å»ºéŸ³é¢‘æ± 
      if (healthCheck.audioPoolStatus && healthCheck.audioPoolStatus.healthScore < 70) {
        console.log('ğŸ§¹ æ¸…ç†å¹¶é‡å»ºéŸ³é¢‘æ± ...')
        this.clearAudioPool()
        await this.preloadNotesByLevel(2) // é‡æ–°é¢„åŠ è½½æ ¸å¿ƒéŸ³ç¬¦
        repairActions.push('é‡å»ºéŸ³é¢‘å®ä¾‹æ± ')
      }
      
      // 3. é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
      if (!healthCheck.audioContextActive) {
        console.log('ğŸ”„ é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡...')
        this.reactivateAudioContext()
        repairActions.push('é‡æ–°æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡')
      }
      
      console.log('âœ… æ™ºèƒ½ä¿®å¤å®Œæˆï¼Œæ‰§è¡Œçš„æ“ä½œ:', repairActions)
      return {
        success: true,
        actions: repairActions,
        healthCheck: await this.performHealthCheck() // ä¿®å¤åé‡æ–°æ£€æŸ¥
      }
      
    } catch (error) {
      console.error('âŒ æ™ºèƒ½ä¿®å¤å¤±è´¥:', error)
      return {
        success: false,
        error: error.message,
        actions: repairActions
      }
    }
  },

  // æ€§èƒ½ç›‘æ§
  getPerformanceStats() {
    const audioDownloadManager = require('./audioDownloadManager')
    const downloadStats = audioDownloadManager.getStats()
    const poolStatus = this.getAudioPoolStatus()
    
    return {
      downloadManager: downloadStats,
      audioPool: poolStatus,
      audioEnabled: this.isAudioEnabled,
      preloadLevel: this.preloadLevel,
      timestamp: new Date().toISOString(),
      overallHealth: this.calculateOverallHealth(downloadStats, poolStatus)
    }
  },

  // è®¡ç®—æ€»ä½“å¥åº·åº¦
  calculateOverallHealth(downloadStats, poolStatus) {
    const downloadHealth = downloadStats.progress.percentage || 0
    const poolHealth = poolStatus.healthScore || 0
    const contextHealth = this.isAudioEnabled ? 100 : 0
    
    const overallScore = Math.round((downloadHealth * 0.5 + poolHealth * 0.3 + contextHealth * 0.2))
    
    let status = 'excellent'
    if (overallScore < 60) status = 'poor'
    else if (overallScore < 80) status = 'fair'
    else if (overallScore < 90) status = 'good'
    
    return {
      score: overallScore,
      status: status,
      issues: this.identifyIssues(downloadStats, poolStatus)
    }
  },

  // è¯†åˆ«é—®é¢˜
  identifyIssues(downloadStats, poolStatus) {
    const issues = []
    
    if (downloadStats.progress.percentage < 80) {
      issues.push('éŸ³é¢‘æ–‡ä»¶ä¸‹è½½ä¸å®Œæ•´')
    }
    
    if (poolStatus.healthScore < 70) {
      issues.push('éŸ³é¢‘å®ä¾‹æ± å¥åº·åº¦ä½')
    }
    
    if (!this.isAudioEnabled) {
      issues.push('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªæ¿€æ´»')
    }
    
    if (downloadStats.successRate < 90) {
      issues.push('éŸ³é¢‘ä¸‹è½½æˆåŠŸç‡ä½')
    }
    
    return issues
  },

  // è‡ªåŠ¨ä¼˜åŒ–
  async autoOptimize() {
    console.log('âš¡ å¼€å§‹è‡ªåŠ¨ä¼˜åŒ–éŸ³é¢‘ç³»ç»Ÿ...')
    
    const stats = this.getPerformanceStats()
    const optimizations = []
    
    try {
      // 1. å¦‚æœå¥åº·åº¦ä½ï¼Œæ‰§è¡Œæ™ºèƒ½ä¿®å¤
      if (stats.overallHealth.score < 70) {
        console.log('ğŸ”§ å¥åº·åº¦ä½ï¼Œæ‰§è¡Œæ™ºèƒ½ä¿®å¤...')
        const repairResult = await this.performSmartRepair()
        if (repairResult.success) {
          optimizations.push('æ™ºèƒ½ä¿®å¤ç³»ç»Ÿ')
        }
      }
      
      // 2. é¢„åŠ è½½ä¼˜åŒ–
      const audioDownloadManager = require('./audioDownloadManager')
      if (stats.downloadManager.progress.success > 20) {
        console.log('âš¡ é¢„åŠ è½½é«˜ä¼˜å…ˆçº§éŸ³é¢‘...')
        await audioDownloadManager.preloadByPriority(8)
        optimizations.push('é¢„åŠ è½½é«˜ä¼˜å…ˆçº§éŸ³é¢‘')
      }
      
      // 3. éŸ³é¢‘æ± ä¼˜åŒ–
      if (stats.audioPool.healthScore < 90 && stats.audioPool.valid < 20) {
        console.log('ğŸµ æ‰©å±•éŸ³é¢‘é¢„åŠ è½½...')
        await this.preloadNotesByLevel(3)
        optimizations.push('æ‰©å±•éŸ³é¢‘é¢„åŠ è½½')
      }
      
      console.log('âœ… è‡ªåŠ¨ä¼˜åŒ–å®Œæˆï¼Œæ‰§è¡Œçš„ä¼˜åŒ–:', optimizations)
      return {
        success: true,
        optimizations: optimizations,
        finalStats: this.getPerformanceStats()
      }
      
    } catch (error) {
      console.error('âŒ è‡ªåŠ¨ä¼˜åŒ–å¤±è´¥:', error)
      return {
        success: false,
        error: error.message,
        optimizations: optimizations
      }
    }
  },

  // éŸ³é¢‘é¢„çƒ­ - ç¡®ä¿é¦–æ¬¡ç‚¹å‡»æœ‰å£°éŸ³
  warmupAudio() {
    console.log('ğŸ”¥ å¼€å§‹éŸ³é¢‘é¢„çƒ­...')
    
    // å»¶è¿Ÿ500msåå¼€å§‹é¢„çƒ­ï¼Œç¡®ä¿ä¸‹è½½ç®¡ç†å™¨å·²åˆå§‹åŒ–
    setTimeout(() => {
      // é¢„çƒ­æœ€å¸¸ç”¨çš„å‡ ä¸ªéŸ³ç¬¦
      const warmupNotes = ['c4', 'd4', 'e4', 'f4', 'g4']
      
      warmupNotes.forEach((noteKey, index) => {
        setTimeout(() => {
          this.preloadNote(noteKey).then((audio) => {
            if (audio && audio !== null) {
              console.log(`ğŸ¹ é¢„çƒ­å®Œæˆ: ${noteKey}`)
            }
          }).catch(error => {
            console.log(`âš ï¸ é¢„çƒ­å¤±è´¥: ${noteKey}`, error)
          })
        }, index * 100) // é”™å¼€100ms
      })
      
      // 1.5ç§’åæ ‡è®°é¢„çƒ­å®Œæˆ
      setTimeout(() => {
        this.isWarmedUp = true
        console.log('âœ… éŸ³é¢‘é¢„çƒ­å®Œæˆ')
      }, 1500)
      
    }, 500)
  }
}

// åˆ›å»ºå…¨å±€éŸ³é¢‘ç®¡ç†å™¨å®ä¾‹
const audioManager = new AudioManager()

module.exports = {
  AudioManager,
  audioManager
} 