# 五线谱简谱学习器 - 微信小程序输出指南

## ⚠️ 当前错误解决方案

### 已解决的问题
1. **✅ tabBar配置错误**：已删除pages.json中的空tabBar配置
2. **⚠️ document API不兼容**：需要进一步处理

### 针对document API错误的解决方案

当前错误是因为项目包含了`index.html`文件，其中有大量Web DOM操作代码。在uni-app项目中，这个文件不应该被包含在小程序构建中。

#### 立即解决方案：

1. **删除或重命名index.html**
```bash
# 重命名为备份文件
mv index.html index.html.backup
```

2. **确保只使用Vue组件**
   - 确保所有页面都是.vue文件
   - 移除任何直接的HTML文件引用

3. **检查构建配置**
   ```json
   // manifest.json中确保mp-weixin配置正确
   "mp-weixin": {
       "appid": "wx7f0a51ddda8faa1a",
       "setting": {
           "urlCheck": false,
           "es6": true,
           "minified": true
       }
   }
   ```

---

## 方案一：HBuilderX编译（推荐 - 最简单）

### 1. 安装HBuilderX
1. 下载 [HBuilderX](https://www.dcloud.io/hbuilderx.html)
2. 选择"App开发版"，包含uni-app编译器

### 2. 项目导入
1. 打开HBuilderX
2. 文件 → 导入 → 从本地目录导入
3. 选择当前项目文件夹
4. 项目类型选择"uni-app"

### 3. 配置小程序
1. 修改 `manifest.json` 中的小程序配置：
```json
{
  "mp-weixin": {
    "appid": "wx7f0a51ddda8faa1a",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "minified": true
    }
  }
}
```

### 4. 编译发布
1. 点击"运行" → "运行到小程序模拟器" → "微信开发者工具"
2. 或点击"发行" → "小程序-微信"

### 5. 注意事项
- 需要安装微信开发者工具
- 需要微信小程序开发者账号
- ✅ 已解决tabBar配置问题
- ⚠️ 需要处理document API兼容性

---

## 方案二：手动适配为微信小程序

### 1. 项目结构调整
```
miniprogram/
├── pages/
│   ├── index/
│   │   ├── index.js
│   │   ├── index.wxml
│   │   ├── index.wxss
│   │   └── index.json
│   └── learning/
│       ├── learning.js
│       ├── learning.wxml
│       ├── learning.wxss
│       └── learning.json
├── components/
│   ├── staff/
│   ├── piano/
│   └── jianpu/
├── utils/
├── app.js
├── app.json
├── app.wxss
└── project.config.json
```

### 2. 核心文件转换

#### app.json
```json
{
  "pages": [
    "pages/index/index",
    "pages/learning/learning"
  ],
  "window": {
    "navigationBarTitleText": "五线谱简谱学习器",
    "navigationBarBackgroundColor": "#667eea",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#667eea"
  },
  "sitemapLocation": "sitemap.json"
}
```

#### 首页 (pages/index/index.wxml)
```xml
<view class="container">
  <view class="title">五线谱简谱对照学习</view>
  
  <view class="mode-selection">
    <view class="selection-title">选择学习模式</view>
    <view class="mode-cards">
      <view class="mode-card {{selectedMode === 'practice' ? 'active' : ''}}" 
            bindtap="selectMode" data-mode="practice">
        <view class="mode-icon">📚</view>
        <view class="mode-name">练习模式</view>
      </view>
      <view class="mode-card {{selectedMode === 'pk' ? 'active' : ''}}" 
            bindtap="selectMode" data-mode="pk">
        <view class="mode-icon">⚔️</view>
        <view class="mode-name">PK模式</view>
      </view>
    </view>
  </view>
  
  <view class="question-selection">
    <view class="selection-title">选择题目数量</view>
    <view class="question-options">
      <view class="question-option {{selectedCount === 15 ? 'active' : ''}}" 
            bindtap="selectCount" data-count="15">
        <view class="option-number">15</view>
        <view class="option-label">道题</view>
      </view>
      <view class="question-option {{selectedCount === 30 ? 'active' : ''}}" 
            bindtap="selectCount" data-count="30">
        <view class="option-number">30</view>
        <view class="option-label">道题</view>
      </view>
    </view>
  </view>
  
  <button class="start-btn {{canStart ? '' : 'disabled'}}" bindtap="startLearning">
    开始学习
  </button>
</view>
```

#### 学习页面组件适配
- **五线谱组件**: 使用Canvas API绘制五线谱，替代ABC.js
- **钢琴组件**: 使用原生view组件实现
- **状态管理**: 使用小程序的全局数据或本地存储

### 3. 关键适配点

#### 音频播放
```javascript
// utils/audio.js
const audioContext = wx.createInnerAudioContext()

export function playNote(frequency, duration = 1000) {
  // 小程序音频播放逻辑
  audioContext.src = generateToneUrl(frequency)
  audioContext.play()
  
  setTimeout(() => {
    audioContext.stop()
  }, duration)
}
```

#### 五线谱绘制
```javascript
// components/staff/staff.js
Component({
  methods: {
    drawStaff() {
      const ctx = wx.createCanvasContext('staffCanvas', this)
      
      // 绘制五线谱
      for (let i = 0; i < 5; i++) {
        const y = 50 + i * 20
        ctx.moveTo(50, y)
        ctx.lineTo(300, y)
        ctx.stroke()
      }
      
      // 绘制音符
      this.drawNote(ctx, this.data.note)
      
      ctx.draw()
    }
  }
})
```

---

## 方案三：使用Taro框架

### 1. 创建Taro项目
```bash
# 安装Taro CLI
npm install -g @tarojs/cli

# 创建项目
taro init music-learning-taro

# 选择Vue模板
```

### 2. 迁移代码
1. 将Vue组件转换为Taro组件
2. 修改样式为小程序兼容格式
3. 适配小程序API

### 3. 编译发布
```bash
# 编译为微信小程序
npm run build:weapp

# 开发模式
npm run dev:weapp
```

---

## 推荐实施步骤

### 第一阶段：选择方案
1. **新手推荐**: 方案一（HBuilderX）- 零配置，直接导入编译
2. **有经验推荐**: 方案二（手动适配）- 完全控制，性能最优
3. **团队开发推荐**: 方案三（Taro）- 代码复用，跨平台

### 第二阶段：核心功能适配
1. ✅ 删除index.html文件避免document API冲突
2. 音频播放功能适配
3. 五线谱显示方案（Canvas绘制 or 图片）
4. 触摸交互优化
5. 性能优化

### 第三阶段：小程序特性
1. 分享功能
2. 数据统计上报
3. 用户登录系统
4. 排行榜功能

### 第四阶段：发布上线
1. 微信小程序开发者账号申请
2. 代码审核提交
3. 版本发布管理

---

## 技术难点及解决方案

### 1. ✅ tabBar配置问题
- **问题**: pages.json中tabBar配置不完整
- **解决**: 已删除不必要的tabBar配置

### 2. ⚠️ document API不兼容
- **问题**: index.html中包含Web DOM操作代码
- **解决**: 删除或重命名index.html文件

### 3. ABC.js库适配
- **问题**: ABC.js库在小程序环境不可用
- **解决**: 使用Canvas API手绘五线谱，或预生成五线谱图片

### 4. Web Audio API适配
- **问题**: 小程序不支持Web Audio API
- **解决**: 使用wx.createInnerAudioContext()播放预录制音频文件

### 5. Vuex状态管理
- **问题**: 小程序不支持Vuex
- **解决**: 使用小程序全局数据或本地存储

### 6. 响应式布局
- **问题**: 小程序尺寸单位差异
- **解决**: 使用rpx单位，适配不同屏幕

---

## 预期工作量

- **方案一（HBuilderX）**: 1-2天（需要处理document API问题）
- **方案二（手动适配）**: 5-7天  
- **方案三（Taro）**: 3-5天

## 建议

**立即操作**: 删除或重命名index.html文件，然后使用HBuilderX重新编译。

**如果您希望快速上线**，建议使用方案一（HBuilderX），现有的uni-app配置已经比较完整，只需要解决document API冲突即可。

**如果您希望最佳性能和完全控制**，建议使用方案二，手动适配为原生小程序代码。 